"use strict";var isProbablySafari=false;var GoogleDataWrapper=function(){function t(t){this.data=t}t.prototype.numSeries=function(){return this.data.getNumberOfColumns()-1};t.prototype.seriesNames=function(){var t=[];for(var e=0;e<this.data.getNumberOfColumns()-1;e++){t.push(this.data.getColumnLabel(e))}return t};t.prototype.seriesMin=function(t){return this.data.getColumnRange(t+1).min};t.prototype.seriesMax=function(t){return this.data.getColumnRange(t+1).max};t.prototype.seriesValue=function(t,e){return this.data.getValue(e,t+1)};t.prototype.seriesLength=function(t){return this.data.getNumberOfRows()};return t}();var JSONDataWrapper=function(){function t(t){if(typeof t==="string"){this.object=JSON.parse(t)}else if(typeof t==="object"){this.object=t}else{throw Error("Please provide a JSON string or derived object.")}}t.prototype.numSeries=function(){return this.object.data.length};t.prototype.seriesNames=function(){var t=[];for(var e=0;e<this.object.data.length;e++){t.push(this.object.data[e].series)}return t};t.prototype.seriesMin=function(t){return Math.min.apply(this,this.object.data[t].values)};t.prototype.seriesMax=function(t){return Math.max.apply(this,this.object.data[t].values)};t.prototype.seriesValue=function(t,e){return this.object.data[t].values[e]};t.prototype.seriesLength=function(t){return this.object.data[t].values.length};return t}();var HTMLTableDataWrapper=function(){function t(t){this.table=t;if(!this.table){throw Error("No table given.")}}t.prototype.numSeries=function(){return this.table.getElementsByTagName("tr")[0].children.length};t.prototype.seriesNames=function(){var t=this.table.getElementsByTagName("th");var e=[];for(var a=0;a<t.length;a++){e.push(t[a].textContent)}return e};t.prototype._seriesFloats=function(t){var e=this.table.getElementsByTagName("td");var a=[];for(var r=0;r<e.length;r++){a.push(parseFloat(e[r].textContent))}return a};t.prototype.seriesMin=function(t){return Math.min.apply(this,this._seriesFloats(t))};t.prototype.seriesMax=function(t){return Math.max.apply(this,this._seriesFloats(t))};t.prototype.seriesValue=function(t,e){return parseFloat(this.table.getElementsByTagName("tr")[e+1].children[t].textContent)};t.prototype.seriesLength=function(t){return this.table.getElementsByTagName("tr").length-1};return t}();var PitchMapper=function(){function t(t,e){this.minimumDatum=t;this.maximumDatum=e;if(this.minimumDatum>this.maximumDatum){throw Error("minimum datum should be <= maximum datum")}}t.prototype.map=function(t){};return t}();var FrequencyPitchMapper=function(){function t(t,e,a,r){this.minimumFrequency=a;this.maximumFrequency=r;PitchMapper.call(this,t,e);if(this.minimumFrequency>this.maximumFrequency){throw Error("minimum frequency should be <= maximum frequency")}this.dataRange=this.maximumDatum-this.minimumDatum}t.prototype=Object.create(PitchMapper.prototype);t.prototype.constructor=t;t.prototype.map=function(t){var e;if(this.dataRange){e=(t-this.minimumDatum)/this.dataRange}else{e=.5}return this.minimumFrequency+e*(this.maximumFrequency-this.minimumFrequency)};return t}();var WebAudioSounder=function(){function t(t){this.context=t}t.prototype.start=function(){this.oscillator=this.context.createOscillator();this.oscillator.connect(this.context.destination);this.oscillator.start(0)};t.prototype.frequency=function(t){this.oscillator.frequency.value=t};t.prototype.stop=function(){this.oscillator.stop()};return t}();var Player=function(){function t(t,e,a,r,i){this.data=e;this.pitchMapper=a;this.sounder=r;if(arguments.length<5){this.visualCallback=null}else{this.visualCallback=i}this.interval=Math.ceil(t/this.data.seriesLength(0));this.seriesMaxIndex=this.data.seriesLength(0)-1;this._state="ready"}t.prototype.playPause=function(){switch(this._state){case"ready":this._play();break;case"playing":this._pause();break;case"paused":this._playLoop();break;case"finished":this._play();break;default:throw Error("Player error: invalid state: "+String(this._state))}};t.prototype._play=function(){this.sounder.start(0);this.playIndex=0;this.skippedCalls=0;this._playLoop()};t.prototype._playLoop=function(){this._state="playing";this._playOne();var t=this;this.intervalID=setInterval(function(){t._playOneWrapper()},this.interval)};t.prototype._playOneWrapper=function(){if(isProbablySafari&&this.interval<10&&this.playIndex!==this.seriesMaxIndex&&this.playIndex%2===0){this.playIndex++;this.skippedCalls++;return}this._playOne()};t.prototype._playOne=function(){if(this.visualCallback!==null){this.visualCallback(0,this.playIndex)}this.sounder.frequency(this.pitchMapper.map(this.data.seriesValue(0,this.playIndex)));if(this.playIndex===this.seriesMaxIndex){clearInterval(this.intervalID);var t=this;setTimeout(function(){t.sounder.stop()},this.interval);this._state="finished"}this.playIndex+=1};t.prototype._pause=function(){clearInterval(this.intervalID);this._state="paused"};t.prototype.stepBackward=function(t){var e=t||50;this.playIndex-=e;if(this.playIndex<0){this.playIndex=0}if(this._state==="paused"){this._playOne()}};t.prototype.stepForward=function(t){var e=t||50;this.playIndex+=e;if(this.playIndex>this.seriesMaxIndex){this.playIndex=this.seriesMaxIndex}if(this._state==="paused"){this._playOne()}};return t}();var AudioContextGetter=function(){function t(){}var e=null;var a=function(){if(window.AudioContext!==undefined){return new window.AudioContext}else if(window.webkitAudioContext!==undefined){isProbablySafari=true;return new window.webkitAudioContext}return null};t.get=function(){return e!==null?e:e=a()};return t}();var googleVisualCallbackMaker=function(t){return function(e,a){t.setSelection([{row:a,column:e+1}])}};var htmlTableVisualCallbackMaker=function(t,e){return function(a,r){var i=t.getElementsByTagName("td");var n;for(var s=0;s<i.length;s++){n=i[s];n.classList.remove(e)}n=t.getElementsByTagName("td")[r];n.classList.add(e)}};var KeyboardHandler=function(){function t(t,e){if(!t){throw Error("No container given")}t.setAttribute("tabindex","0");t.addEventListener("keydown",this.keypressHandler.bind(this));if(!e){throw Error("No Player given")}this.player=e}function e(t){if(t.key){return t.key}else if(t.keyIdentifier){return t.keyIdentifier}throw new Error("Keyboard Events API unsupported")}t.prototype.keypressHandler=function(t){t.preventDefault();if(e(t)==="Right"){this.handleRight()}else if(e(t)==="Left"){this.handleLeft()}else if(e(t)==="U+0020"){this.handleSpace()}};t.prototype.handleLeft=function(){this.player.stepBackward()};t.prototype.handleRight=function(){this.player.stepForward()};t.prototype.handleSpace=function(){this.player.playPause()};return t}();var _AudioChart=function(){function t(e,a){var r=t._assignWrapperCallback(e);var i=new r.Wrapper(r.parameter);var n=r.callback;var s=new FrequencyPitchMapper(i.seriesMin(0),i.seriesMax(0),e.frequencyLow,e.frequencyHigh);var o=new WebAudioSounder(a);this.player=new Player(e.duration,i,s,o,n);if(e.chartContainer){new KeyboardHandler(e.chartContainer,this.player)}}t.prototype.playPause=function(){this.player.playPause()};t._assignWrapperCallback=function(t){var e={Wrapper:null,parameter:null,callback:null};switch(t.type){case"google":e.Wrapper=GoogleDataWrapper;e.parameter=t.data;if(t.hasOwnProperty("chart")){e.callback=googleVisualCallbackMaker(t.chart)}break;case"json":e.Wrapper=JSONDataWrapper;e.parameter=t.data;break;case"htmlTable":e.Wrapper=HTMLTableDataWrapper;e.parameter=t.table;if(t.hasOwnProperty("highlightClass")){e.callback=htmlTableVisualCallbackMaker(t.table,t.highlightClass)}break;default:throw Error("Invalid data type '"+t.type+"' given.")}return e};return t}();var AudioChart=function(){function t(t,e){var a="Sorry, your browser doesn't support the Web Audio API.";if(arguments.length<2){e=AudioContextGetter.get();if(e===null){throw Error(a)}}return new _AudioChart(t,e)}return t}();exports.AudioChart=AudioChart;